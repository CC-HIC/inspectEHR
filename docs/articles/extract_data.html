<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to extract data using inspectEHR • inspectEHR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to extract data using inspectEHR">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">inspectEHR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/extract_data.html">How to extract data using inspectEHR</a>
    </li>
    <li>
      <a href="../articles/overview.html">An overview of inspectEHR</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/CC-HIC/inspectEHR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>How to extract data using inspectEHR</h1>
                        <h4 class="author">Edward Palmer</h4>
            
            <h4 class="date">2019-08-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/CC-HIC/inspectEHR/blob/master/vignettes/extract_data.Rmd"><code>vignettes/extract_data.Rmd</code></a></small>
      <div class="hidden name"><code>extract_data.Rmd</code></div>

    </div>

    
    
<p>inspectEHR contains a number of helper functions for wrangling data. These will be ported over to cleanEHR to keep the roles of the two packages clear.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># If you need inspectEHR</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co"># library(devtools)</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># install_github("CC-HIC/inspectEHR", ref = "sql")</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(inspectEHR) <span class="co"># note extract is masked by tidyverse</span></a></code></pre></div>
<p>I strongly advise running tidyverse. Whilst you don’t need it, inspectEHR has been written with tidyeval in mind, and as such works best in the tidyverse ecosystem.</p>
<p>Establish a database connection. You will most likely be working with sqlite as the postgres instance is confined to the UCL IDHS.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Establish a DB connection and retrive tables</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">ctn &lt;-<span class="st"> </span><span class="kw"><a href="../reference/connect.html">connect</a></span>(<span class="dt">system =</span> <span class="st">"sqlite"</span>, <span class="dt">file =</span> <span class="st">"~/path/public_release_yyyymmdd.sqlite3"</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">tbls &lt;-<span class="st"> </span><span class="kw"><a href="../reference/retrieve_tables.html">retrieve_tables</a></span>(ctn)</a></code></pre></div>
<p>the tbls object is now a list of all tables within the database and can be accessed via the <code>tbls[["table"]]</code> syntax.</p>
<p>Enter the fields you want to extract using HIC codes. See the cleanEHR repo for more information on these codes. I write this here as a tribble to keep everything in the same document. If you want to rename column names then it is important to keep names and code names together and in the same order.</p>
<p>It’s best to separate out 1d and 2d data.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># Grab non-longitudinal (1d) data ----------------</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">demo_codes &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="op">~</span>hic_codes, <span class="op">~</span>short_name,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">  <span class="st">"NIHR_HIC_ICU_0399"</span>, <span class="st">"primary_admission_reason"</span>,</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">  <span class="st">"NIHR_HIC_ICU_0097"</span>, <span class="st">"unit_mortality"</span>,</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co"># Extract 1d data</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">dtb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_demographics.html">extract_demographics</a></span>(<span class="dt">events =</span> tbls[[<span class="st">"events"</span>]],</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">                            <span class="dt">metadata =</span> tbls[[<span class="st">"variables"</span>]],</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">                            <span class="dt">code_names =</span> demo_codes<span class="op">$</span>hic_codes,</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">                            <span class="dt">rename =</span> demo_codes<span class="op">$</span>short_name)</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co"># Grab longitudinal (2d) data ---------------------</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"></a>
<a class="sourceLine" id="cb3-18" data-line-number="18">long_codes &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">  <span class="op">~</span>hic_codes, <span class="op">~</span>short_name,</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">  <span class="st">"NIHR_HIC_ICU_0411"</span>, <span class="st">"start_dttm"</span>, <span class="co"># ALWAYS</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21">  <span class="st">"NIHR_HIC_ICU_0150"</span>, <span class="st">"fio2"</span>,</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">  <span class="st">"NIHR_HIC_ICU_0470"</span>, <span class="st">"norad"</span>,</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">  <span class="st">"NIHR_HIC_ICU_0132"</span>, <span class="st">"pxo2"</span>)</a></code></pre></div>
<p>We can now extact 2d data. This will return a table with 1 row per patient per time unit specified in the cadance option. For example, a cadance of 1 will return a table with 1 row per patient per hour. This will be a complete (non-sparse) table, so if nothing was recorded for a partiular hour, that hour will not appear as a row.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">ltb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_timevarying.html">extract_timevarying</a></span>(</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="dt">events =</span> tbls[[<span class="st">"events"</span>]],</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="dt">code_names =</span> long_codes<span class="op">$</span>hic_codes,</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="dt">metadata =</span> <span class="kw">collect</span>(tbls[[<span class="st">"variables"</span>]]),</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  <span class="dt">chunk_size =</span> <span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="dt">cadance =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  <span class="dt">rename =</span> long_codes<span class="op">$</span>short_name)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co"># I recomend saving here... depending on how much data you are trying to wrangle, that step can take a long time.</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co"># save(dtb, ltb, demo_codes, long_codes, file = "./backup.RData")</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co"># Expand this dense tb (i.e. add NAs where appropraite)</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">ltb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/expand_missing.html">expand_missing</a></span>(ltb)</a></code></pre></div>
<p>expand_missing serves to fill in the gaps with NAs so the table haas a regular cadance.</p>
<p>You can also run extract_timevarying with the option of cadance = “exact”, but I advise against this if you are taking a large amount of data out of the database.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Edward Palmer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
